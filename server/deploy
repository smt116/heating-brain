#!/usr/bin/env bash

set -e

green=`tput setaf 2`
yellow=`tput setaf 3`
blue=`tput setaf 4`
reset=`tput sgr0`

function label() {
  echo
  echo "${green}$1${reset}"
}

function run() {
  echo "${blue}Running ${yellow}$@${reset}"
  eval $@
}

label "Building static assets"
run "npm --prefix apps/interface/assets install"
run "npm --prefix apps/interface/assets run deploy"

label "Digesting and compressing static files"
run "cd apps/interface"
run "mix phx.digest"
run "cd -"

label "Uploading files to the server"
run "rsync -rav --exclude-from=.gitignore --exclude=.git --prune-empty-dirs . brain:/opt/heating_brain"

label "Updating systemd service unit"
run "ssh brain \"cp /opt/heating_brain/server/systemd/user/heating_brain.service ~/.config/systemd/user/heating_brain.service\""

label "Reloading systemd daemon"
run "ssh brain \"systemctl --user daemon-reload\""

label "Enabling systemd service unit"
run "ssh brain \"systemctl --user enable heating_brain\""

label "Backing up database"
run "ssh brain \"tar -czvf /srv/backups/mnesia.$(date +'%Y.%m.%d.%R').tar.gz /opt/heating_brain/mnesia\""
run "ssh brain \"find /srv/backups -type f -mtime +30 -ls -exec rm -f -- {} \;\""

label "Creating a new release"
run "ssh brain \"/opt/heating_brain/server/compile\""

label "Restarting the application"
run "ssh brain \"/bin/systemctl --user restart heating_brain\""
